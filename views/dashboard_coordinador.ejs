<%- include('includes/_nav_coordinador.ejs') %>
  <%- include('includes/_header_coordinador.ejs') %>

    <main class="bg-grey flex-grow-1 rounded-5 p-0 d-flex flex-column materia-scroll" style="height: 100vh;">
      <div class="mb-4">
        <h1 class="ms-3 mt-2">Dashboard</h1>
        <div style="border-bottom: 3px solid #84251C; width: 15rem; margin-top: -10px;"></div>
        <% if (msg1) { %>
          <div class="modal fade" id="msg1Modal" tabindex="-1" aria-labelledby="msg1ModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-sm">
              <div class="modal-content align-items-center rounded-5">
                <div class="modal-header border border-0">
                  <h5 class="modal-title ivd-text-red" id="msg1ModalLabel">Sincronizar Ciclos Escolares</h5>
                </div>
                <div class="modal-body bg-grey rounded-5 text-center px-5">
                  <%- msg1 %>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn ivd-bg-red text-white rounded-5"
                    data-bs-dismiss="modal">Aceptar</button>
                </div>
              </div>
            </div>
          </div>
          <% } %>

            <% if (msg2) { %>
              <div class="modal fade" id="msg2Modal" tabindex="-1" aria-labelledby="msg2ModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-sm">
                  <div class="modal-content align-items-center rounded-5">
                    <div class="modal-header border border-0">
                      <h5 class="modal-title ivd-text-red" id="msg2ModalLabel">Sincronizar Planes de Estudio</h5>
                    </div>
                    <div class="modal-body bg-grey rounded-5 text-center px-5">
                      <%- msg2 %>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn ivd-bg-red text-white rounded-5"
                        data-bs-dismiss="modal">Aceptar</button>
                    </div>
                  </div>
                </div>
              </div>
              <% } %>




                <div class="d-grid gap-2 d-md-flex justify-content-md-end position-relative" style="margin-top: -40px;">

                  <button
                    class="btn btn-primary d-flex align-items-center gap-2 rounded-pill px-3 py-1 me-3 mt-3 ivd-bg-red"
                    data-bs-toggle="modal" data-bs-target="#resetGroupsModal" style="border: none;">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                      class="bi bi-trash" viewBox="0 0 16 16">
                      <path
                        d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5m3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0z" />
                      <path
                        d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4zM2.5 3h11V2h-11z" />
                    </svg>
                    Eliminar Inscripción
                  </button>


                  <form action="/coordinador/ciclo-escolar/sincronizar" method="POST">
                    <button
                      class="btn rounded-pill px-3 py-2 ivd-bg-red text-white d-flex align-items-center gap-2 me-3 mt-3"
                      type="submit">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-arrow-clockwise" viewBox="0 0 16 16" style="margin-left: -2px">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
                        <path
                          d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
                      </svg>
                      Sincronizar Ciclos Escolares
                    </button>
                  </form>
                  <form action="/coordinador/dashboard/sincronizar-planes-de-estudio" method="POST">
                    <button type="submit"
                      class="btn btn-primary d-flex align-items-center gap-2 rounded-pill px-3 py-2 me-3 mt-3 ivd-bg-red"
                      style="border: none;">
                      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                        class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
                        <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
                        <path
                          d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466" />
                      </svg>
                      Sincronizar Planes de estudio
                    </button>
                  </form>
                </div>

                <div class="modal fade" id="resetGroupsModal" tabindex="-1" aria-labelledby="resetGroupsModalLabel"
                  aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content align-items-center rounded-5 px-4">
                      <div class="modal-header border border-0 py-3">
                        <h5 class="modal-title ivd-text-red" id="resetGroupsModalLabel">Eliminar Inscripción</h5>
                      </div>
                      <div class="modal-body bg-grey rounded-5 text-center py-4 px-3">
                        Usted está eliminado los datos del registro de la inscripción anterior. <br>
                        Esta acción no se puede deshacer.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary rounded-pill me-3 "
                          style="background-color: white; border: 1px solid #84251C; color: #84251C;"
                          data-bs-dismiss="modal"> Cancelar</button>
                        <button id="confirmResetBtn" class="btn ivd-bg-red text-white rounded-5">
                          Aceptar
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered modal-sm">
                    <div class="modal-content align-items-center rounded-5">
                      <div class="modal-header border border-0">
                        <h5 class="modal-title ivd-text-red">Eliminar Inscripción</h5>
                      </div>
                      <div class="modal-body bg-grey rounded-5 text-center py-4 px-4">
                        Los datos han sido eliminados <br> correctamente.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn ivd-bg-red text-white rounded-5"
                          id="successConfirmBtn">Aceptar</button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="d-flex flex-wrap justify-content-start w-100 mt-4" style="gap: 10px;">
                  <div class="card rounded-5 ivd-bg-red bg-gradient text-white flex-grow-1 ms-3"
                    style="min-width: 173.5px; flex-basis: 17.4%;">
                    <div class="card-body px-0 text-start w-100" style="margin-top: -5px;">
                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title ms-3">Materias Abiertas</p>
                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/materias';"
                          style="width: 20px; height: 20px; margin-top: -10px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm" viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div style="border-bottom: 3px solid #ffffff; min-width: 100%; margin-top: -7px;"></div>
                      <p id="materiasAbiertasCount" class="card-text text-start ms-4" style="margin-top: 10px; font-size: 2rem;">
                        <%= materias_Abiertas %>
                      </p>
                    </div>
                  </div>

                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black flex-grow-1"
                    style="min-width: 173.5px; flex-basis: 17.4%;">
                    <div class="card-body px-0 text-start w-100" style="margin-top: -5px;">
                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title ms-3">Grupos Abiertos</p>
                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/grupos';"
                          style="width: 20px; height: 20px; margin-top: -10px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm  " viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div style="border-bottom: 3px solid #84251c98; width: 100%; margin-top: -7px;"></div>
                      <p id="gruposTotalesCount" class="card-text text-start ms-4" style="margin-top: 10px; font-size: 2rem;">
                        <%= grupos_Totales %>
                      </p>
                    </div>
                  </div>


                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black flex-grow-1"
                    style="min-width: 173.5px; flex-basis: 17.4%;">
                    <div class="card-body px-0 text-start w-100" style="margin-top: -5px;">
                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title ms-3">Alumnos Inscritos</p>
                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/alumnos';"
                          style="width: 20px; height: 20px; margin-top: -10px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm  " viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div style="border-bottom: 3px solid #84251c98; width: 100%; margin-top: -7px;"></div>
                      <p id="alumnosInscritosCount" class="card-text text-start ms-4" style="margin-top: 10px; font-size: 2rem;">
                        <%= alumnosInscritos %>
                      </p>
                    </div>
                  </div>

                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black flex-grow-1"
                    style="min-width: 173.5px; flex-basis: 17.4%;">
                    <div class="card-body px-0 text-start w-100" style="margin-top: -5px;">
                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title ms-3">Alumnos No Inscritos</p>
                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/alumnos';"
                          style="width: 20px; height: 20px; margin-top: -10px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm  " viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div style="border-bottom: 3px solid #84251c98; width: 100%; margin-top: -7px;"></div>
                      <p id="alumnosNoInscritosCount" class="card-text text-start ms-4" style="margin-top: 10px; font-size: 2rem;">
                        <%= alumnosNoInscritos %>
                      </p>
                    </div>
                  </div>

                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black flex-grow-1 me-3"
                    style="min-width: 173.5px; flex-basis: 17.4%;">
                    <div class="card-body px-0 text-start w-100" style="margin-top: -5px;">
                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title ms-3">Alumnos Sin Materias</p>

                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/alumnos';"
                          style="width: 20px; height: 20px; margin-top: -10px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm  " viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div style="border-bottom: 3px solid #84251c98; width: 100%; margin-top: -7px;"></div>
                      <p id="alumnosSinMateriasCount" class="card-text text-start ms-4" style="margin-top: 10px; font-size: 2rem;">
                        <%= alumnosSinMaterias %>
                      </p>
                    </div>
                  </div>

                </div>

                <div class="d-flex flex-wrap justify-content-start w-100 mt-4" style="gap: 10px;">
                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black d-flex flex-column ms-3 col-lg-4"
                    style="max-width: 37.5%; flex-grow: 1;">
                    <div class="card-header bg-transparent border-0 px-3 pt-3 pb-0">

                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title m-0">Grupos</p>

                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/grupos';"
                          style="width: 20px; height: 20px; margin-top: -1px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm  " viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div class="border-bottom border-3 mt-2" style="border-color: #84251c98 !important;"></div>
                    </div>

                    <div class="card-body p-0 dashboard-scroll" style="max-height: 150px;">
                      <div class="px-3 pt-2"
                        style="width: auto; min-width: 600px; overflow-x: auto !important; overflow-y: hidden !important;">
                        <div class="table-responsive">
                          <table id="tabla-grupos" class="table table-sm">
                            <thead>
                              <th scope="col" style="width: 20%; min-width: 100px;" class="align-middle">Nombre
                              </th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">Hora
                                Inicio</th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">Hora
                                Fin</th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">Día
                              </th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">
                                Profesor</th>
                            </thead>
                            <tbody>
                              <% if (grupos_Dashboard && grupos_Dashboard.length> 0) { %>
                                <% grupos_Dashboard.forEach(bloque=> { %>
                                  <tr>
                                    <td style="max-width: 300px; white-space: normal; word-break: break-word;">
                                      <%= bloque.materia_nombre %>
                                    </td>
                                    <td> [<%= bloque.hora_inicio %>
                                    </td>
                                    <td>
                                      <%= bloque.hora_fin %>]
                                    </td>
                                    <td>
                                      <%= bloque.dia %>
                                    </td>

                                    <td style="max-width: 300px; white-space: normal; word-break: break-word;">
                                      <%= bloque.profesor_nombre %>
                                    </td>
                                  </tr>
                                  <% }); %>
                                    <% } else { %>
                                      <tr>
                                        <td colspan="2">No hay grupos disponibles</td>
                                      </tr>
                                      <% } %>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-transparent border-0 py-2 px-3">
                      <small id="grupoTotalesCount" class="text-muted">Total: <%= grupos_Totales %> grupos</small>
                    </div>
                  </div>



                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black d-flex flex-column"
                    style="max-width: 22%; flex-grow: 1;">
                    <div class="card-header bg-transparent border-0 p-0">
                      <div class="px-3 pt-3">
                        <div class="d-flex align-items-center justify-content-between">
                          <p class="card-title m-0">Salones Asignados</p>
                          <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                            onclick="window.location.href='/coordinador/salones';"
                            style="width: 20px; height: 20px; margin-top: -1px;">
                            <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                              viewBox="0 0 16 16">
                              <path fill-rule="evenodd"
                                d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                            </svg>
                          </button>
                        </div>
                      </div>
                      <div class="border-bottom border-3 mt-2 w-100" style="border-color: #84251c98 !important;">
                      </div>
                    </div>
                    <div class="card-body dashboard-scroll p-0" style="max-height: 150px; overflow-x: auto;">
                      <div class="px-3 pt-2">
                        <div class="table-responsive">
                          <table id="tabla-salones" class="table table-sm">
                            <thead>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">Número
                              </th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">
                                Capacidad</th>
                            </thead>
                            <tbody>
                              <% if (salones_Dashboard && salones_Dashboard.length> 0) { %>
                                <% salones_Dashboard.forEach(function(salon) { %>
                                  <tr>
                                    <td>
                                      <%= salon.numero %>
                                    </td>
                                    <td>
                                      <%= salon.capacidad || '0' %>
                                    </td>
                                  </tr>
                                  <% }); %>
                                    <% } else { %>
                                      <tr>
                                        <td colspan="2">No hay salones disponibles</td>
                                      </tr>
                                      <% } %>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-transparent border-0 py-2 px-3">
                      <small id="salonesTotalesCount" class="text-muted">Total: <%= salon_Totales %> salones</small>
                    </div>
                  </div>

                  <div class="card rounded-5 ivd-bg-white bg-gradient text-black d-flex flex-column me-3 col-lg-4"
                    style="max-width: 37.5%; flex-grow: 1;">
                    <div class="card-header bg-transparent border-0 px-3 pt-3 pb-0">

                      <div class="d-flex align-items-center justify-content-between">
                        <p class="card-title m-0">Solicitudes de Cambio de Horario </p>

                        <button class="ratio ratio-1x1 rounded-circle overflow-hidden me-2" type="button"
                          onclick="window.location.href='/coordinador/solicitudes-cambio';"
                          style="width: 20px; height: 20px; margin-top: -1px;">
                          <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="black"
                            class="bi bi-arrow-up-right bi-arrow-up-right-sm  " viewBox="0 0 16 16">
                            <path fill-rule="evenodd"
                              d="M14 2.5a.5.5 0 00-.5-.5h-6a.5.5 0 0 0 0 1h4.793L2.146 13.146a.5.5 0 0 0 .708.708L13 3.707V8.5a.5.5 0 0 0 1 0z" />
                          </svg>
                        </button>
                      </div>
                      <div class="border-bottom border-3 mt-2" style="border-color: #84251c98 !important;"></div>
                    </div>

                    <div class="card-body dashboard-scroll p-0" style="max-height: 150px;">
                      <div class="px-3 pt-2">
                        <div class="table-responsive">
                          <table id="tabla-solicitudes" class="table table-sm">
                            <thead>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">
                                ID
                              </th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">
                                Nombre
                              </th>
                              <th scope="col" style="width: 15%; min-width: 100px;" class="align-middle">
                                Fecha
                              </th>
                            </thead>
                            <tbody>
                              <% if (solicitud_Cambio_Dashboard && solicitud_Cambio_Dashboard.length> 0) { %>
                                <% solicitud_Cambio_Dashboard.forEach(solicitud=> { %>
                                  <tr>
                                    <td>
                                      <%= solicitud.solicitud_cambio_id %>
                                    </td>
                                    <td style="max-width: 300px; white-space: normal; word-break: break-word;">
                                      <%= solicitud.nombre %>
                                        <%= solicitud.primer_apellido %>
                                    </td>
                                    <td style="max-width: 300px; white-space: normal; word-break: break-word;">
                                      <%= new Date(solicitud.created_at).toLocaleString('es-ES', { year: 'numeric' ,
                                        month: '2-digit' , day: '2-digit' , hour: '2-digit' , minute: '2-digit' ,
                                        hour12: false }).replace(',', '' ) %>
                                    </td> %>
                                    </td>
                                  </tr>
                                  <% }); %>
                                    <% } else { %>
                                      <tr>
                                        <td colspan="2">No hay solicitudes de cambio disponibles</td>
                                      </tr>
                                      <% } %>
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>

                    <div class="card-footer bg-transparent border-0 py-2 px-3">
                      <small id="solicitudesTotalesCount" class="text-muted">Total: <%= total_Solicitudes%> solicitudes</small>
                    </div>
                  </div>
                </div>

                <div class="container" style="min-width: 100%;">

                  <div class="row justify-content-center mt-3 mb-4">
                    <div class="px-3">
                      <div id="chart-data" data-json='<%= JSON.stringify(grafica_Alumnos || []) %>'
                        style="display:none;">
                      </div>
                      <div class="card rounded-5 ivd-bg-white bg-gradient text-black ">
                        <div class="card-header bg-transparent border-0 p-0">
                          <div class="px-3 pt-3">
                            <div class="d-flex align-items-center justify-content-between">
                              <p class="card-title m-0 w-100 text-center">Comparación de Alumnos por Semestre
                              </p>
                            </div>
                          </div>
                        </div>
                        <div class="card-body">
                          <canvas id="grafica_Alumnos" height="50" width="300"></canvas>
                        </div>
                      </div>
                    </div>
                  </div>
    </main>
    </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Chart.js para poder utilizar graficos. 
      //Se aplica el cambio de Objeto js a Json en el html debido a que se conserva la estructura de datos
      //En vez de ser manejados de manera de objetos.
      // A cuestiones de vulnabilidad y porque el JSON 
      //Antes de ejecutar el codigo se espera para que exista la variable ctx
      document.addEventListener('DOMContentLoaded', () => {
        const msg1Modal = document.getElementById('msg1Modal');
        const msg2Modal = document.getElementById('msg2Modal');

        if (msg1Modal) {
            const modal = new bootstrap.Modal(msg1Modal);
            modal.show();
            history.replaceState(null, '', window.location.pathname);
        }
        
        if (msg2Modal) {
            const modal = new bootstrap.Modal(msg2Modal);
            modal.show();
            history.replaceState(null, '', window.location.pathname);
        }
        
        const rawData = document.getElementById('chart-data').dataset.json;
        const initialData = JSON.parse(rawData);

        const ctx = document.getElementById('grafica_Alumnos').getContext('2d');
        window.miGrafica = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: initialData.map(d => `${d.semestre} Semestre`),
            datasets: [
              {
                label: 'Inscritos',
                data: initialData.map(d => d.inscritos),
                backgroundColor: '#000000',    // mismo estilo de la tabla
                borderColor: '#000000',
                borderWidth: 1
              },
              {
                label: 'No Inscritos',
                data: initialData.map(d => d.no_inscritos),
                backgroundColor: '#84251c',    // ídem
                borderColor: '#84251c',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1
                }
              }
            }
          }
        });
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/coordinador.js"></script>

    <script>
      async function actualizarDashboard() {
        try {
          // 1) Petición al servidor para obtener los datos filtrados
          const res = await fetch('/coordinador/dashboard/filtrado', { method: 'GET' });
          if (!res.ok) {
            throw new Error(`HTTP ${res.status} – Error obteniendo datos del dashboard`);
          }
          const data = await res.json();

          // 2) Actualizar contadores (cards)
          document.getElementById('materiasAbiertasCount').textContent = data.materiasAbiertas;
          document.getElementById('gruposTotalesCount').textContent = data.gruposTotales;
          document.getElementById('alumnosInscritosCount').textContent = data.alumnosInscritos;
          document.getElementById('alumnosNoInscritosCount').textContent = data.alumnosNoInscritos;
          document.getElementById('alumnosSinMateriasCount').textContent = data.alumnosSinMaterias;
          document.getElementById('grupoTotalesCount').textContent = `Total: ${data.gruposTotales} grupos`;
          document.getElementById('salonesTotalesCount').textContent = `Total: ${data.salon_Totales} salones`;
          document.getElementById('solicitudesTotalesCount').textContent = `Total: ${data.total_Solicitudes} solicitudes`;

          // 3) Regenerar tablas dinámicamente
          const tbodyGrupos = document.querySelector('#tabla-grupos tbody');
          const tbodySalones = document.querySelector('#tabla-salones tbody');
          const tbodySolic = document.querySelector('#tabla-solicitudes tbody');

          tbodyGrupos.innerHTML = data.grupos_Dashboard.map(g => `
            <tr>
              <td>${g.materia_nombre}</td>
              <td>${g.hora_inicio}</td>
              <td>${g.hora_fin}</td>
              <td>${g.dia}</td>
              <td>${g.profesor_nombre}</td>
            </tr>
          `).join('');

          tbodySalones.innerHTML = data.salones_Dashboard.map(s => `
            <tr>
              <td>${s.numero}</td>
              <td>${s.capacidad ?? 0}</td>
            </tr>
          `).join('');

          tbodySolic.innerHTML = data.solicitud_Cambio_Dashboard.map(s => `
            <tr>
              <td>${s.solicitud_cambio_id}</td>
              <td>${s.nombre} ${s.primer_apellido}</td>
              <td>${new Date(s.created_at).toLocaleString('es-MX')}</td>
            </tr>
          `).join('');

          // 4) Actualizar la gráfica (Chart.js)
          if (window.miGrafica) {
            const labels = data.grafica_Alumnos.map(d => `${d.semestre} Semestre`);
            const inscritos = data.grafica_Alumnos.map(d => d.inscritos);
            const noInscritos = data.grafica_Alumnos.map(d => d.no_inscritos);

            window.miGrafica.data.labels = labels;
            window.miGrafica.data.datasets[0].data = inscritos;
            window.miGrafica.data.datasets[1].data = noInscritos;
            window.miGrafica.update();
          }

        } catch (err) {
          console.error('Error al actualizar dashboard:', err);
        }
      }

      // Ejecuta cada vez que recibas tu CustomEvent tras guardar carreras
      window.addEventListener('carrerasGuardadas', actualizarDashboard);

      document.getElementById('confirmResetBtn').addEventListener('click', async () => {
        const btn = document.getElementById('confirmResetBtn');
        const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetGroupsModal'));

        try {
          btn.disabled = true;
          btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Procesando...';

          const response = await fetch('/coordinador/dashboard/reset-grupos', {
            method: 'POST'
          });

          if (!response.ok) throw new Error('Server error');
          const result = await response.json();
          if (result.error) throw new Error(result.error);

          resetModal.hide();

          const successModal = new bootstrap.Modal(document.getElementById('successModal'));
          successModal.show();

          document.getElementById('successConfirmBtn').onclick = () => {
            successModal.hide();
            window.location.reload(true);
          };

        } catch (error) {
          console.error('Error:', error);
          alert('Error: ' + (error.message || 'No se pudo completar la operación'));
        } finally {
          btn.disabled = false;
          btn.textContent = 'Aceptar';
        }
      });
    </script>


    </body>

    </html>